---
title: "Simulations of estimating causal effects using undersmoothed HAL"
author: "Seraphina Shi"
date: "2024-7-25"
output:
  html_document:
    toc: true
    toc_float: true
---
```{r setup, include = FALSE}
library(here)
library(dplyr)
library(glmnet)
library(hal9001)
library(readr)
library(ggplot2)
library(gam)

plotFolder <- here("images")
if(!file.exists(plotFolder)) dir.create(plotFolder,recursive=TRUE)

knitr::opts_chunk$set(
  cache=FALSE, autodep=FALSE, warning=FALSE, message=FALSE, echo=TRUE,
  results = 'markup', dev='png', dpi=150, fig.align = "center", fig.path=paste0(plotFolder, "/"),
  cache.path=".cache/",
  duplicate.label="allow"
)

```


# 2. Load the HAL-DRC functions
downloaded from https://github.com/SeraphinaShi/HAL-DoseResponseCurve/tree/main/R
```{r}
R.files.sources <- c(list.files("R", pattern="*.R$", full.names=TRUE))
print(R.files.sources)

sapply(R.files.sources, source)
```

# 3.  load data
```{r}
obs <- read_csv("~/Downloads/Kelly_sample_data.csv")
obs <- rename(obs, W = X)

head(obs)
```

```{r data_visual, fig.height=4, fig.width=4}
### Function to add correlation coefficients
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...) {
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  Cor <- abs(cor(x, y)) # Remove abs function if desired
  txt <- paste0(prefix, format(c(Cor, 0.123456789), digits = digits)[1])
  if(missing(cex.cor)) {
    cex.cor <- 0.4 / strwidth(txt)
  }
  text(0.5, 0.5, txt,
       cex = 1 + cex.cor * Cor) # Resize the text by level of correlation
}

# Plotting the correlation matrix
pairs(obs,
      upper.panel = panel.cor,    # Correlation panel
      lower.panel = panel.smooth) # Smoothed regression lines
```

# 4. Estimate the Dose-Response Curve with HAL-based plugin estimator.
## 4.1 fit undersmoothed smoothness-order adaptive HAL
```{r}
  # Note that fitting undersmoothed smoothness-order adaptive HAL takes the 
  # longest time to run.
DRC_fit_UAdaptive <- fit_UHAL_DRC(
  dat=obs, y_var_name="Y", trt_var_name="A", family="gaussian")

# summary(DRC_fit_UAdaptive$hal_fit)

# Preview the fitted curve data
DRC_fit_UAdaptive$curve_est |> head()
## No CI outputted
```

The output pointwise confidence intervals is NA, so try another HAL-fit without undersmoothing

## 4.2 Fit 1st smoothness order HAL-based DUC
```{r}
DRC_fit_1HAL <- fit_UHAL_DRC(
  dat=obs, y_var_name="Y", trt_var_name="A", family="gaussian", 
  Unsersmoothing = FALSE,
  smoothOrderAdapt = FALSE, smoothOrder = 1)

# Preview the fitted curve data
DRC_fit_1HAL$curve_est |> head()
```

## 4.3 fit smoothness-order adaptive HAL
```{r}
DRC_fit_Adaptive <- fit_UHAL_DRC(
  dat=obs, y_var_name="Y", trt_var_name="A", family="gaussian",
  Unsersmoothing = FALSE)

# Preview the fitted curve data
DRC_fit_Adaptive$curve_est |> head()
```

## 4.4 fit zero-order adaptive HAL
```{r}
DRC_fit_zeroHAL <- fit_UHAL_DRC(
  dat=obs, y_var_name="Y", trt_var_name="A", family="gaussian", 
  Unsersmoothing = FALSE,
  smoothOrderAdapt = FALSE, smoothOrder = 0)

# Preview the fitted curve data
DRC_fit_zeroHAL$curve_est |> head()
```

## 4.5 fit undersmoothed zero-order adaptive HAL
```{r}
DRC_fit_UzeroHAL <- fit_UHAL_DRC(
  dat=obs, y_var_name="Y", trt_var_name="A", family="gaussian", 
  Unsersmoothing = TRUE,
  smoothOrderAdapt = FALSE, smoothOrder = 0)

# Preview the fitted curve data
DRC_fit_UzeroHAL$curve_est |> head()
```

# 5. Visual the estimated curve
```{r}
df_ests <- DRC_fit_UAdaptive$curve_est |>
  mutate(method = "U_Adaptive_HAL") |>
  rbind(DRC_fit_1HAL$curve_est |>
          mutate(method = "1order_HAL")) |>
  rbind(DRC_fit_Adaptive$curve_est |>
          mutate(method = "Adaptive_HAL")) |>
  rbind(DRC_fit_zeroHAL$curve_est |>
          mutate(method = "U_0order_HAL")) |>
  rbind(DRC_fit_UzeroHAL$curve_est |>
          mutate(method = "0order_HAL")) 

ggplot(df_ests, aes(x = a, y = y_hat, color = method, fill = method)) +
  geom_line() +
  geom_point() + 
  ylim(c(0,100)) +
  geom_ribbon(aes(ymin=ci_lwr, ymax=ci_upr),alpha=0.3) +
  theme_bw() +
  labs(title = "Estimated DRCs with available 95% CIs")
```

## Compare with GAM
```{r}
model_fit <- gam(as.formula("Y ~ s(W) + s(A)"),
                 data = obs)

eval_points <- df_ests$a
psi_hat_pnt <- matrix(NA, nrow = length(eval_points), ncol = 5)
colnames(psi_hat_pnt) = c("a", "y_hat", "SE", "ci_lwr", "ci_upr")
for (i in 1:length(eval_points)) {
  psi_hat_pnt[i,1] = eval_points[i]
  
  X_new <- obs[,c("W", "A")]
  X_new[, colnames(X_new)=='A'] = eval_points[i]
  
  predictions <- predict(model_fit, newdata = X_new, se.fit = TRUE)
  
  y_hat <-  mean(predictions)
  # SE <-  mean(predictions$se.fit)
  SE <- NA
  
  psi_hat_pnt[i,2] = y_hat
  psi_hat_pnt[i,3] = SE
  psi_hat_pnt[i,4] = y_hat - 1.96 * SE
  psi_hat_pnt[i,5] = y_hat + 1.96 * SE
} 

df_ests <- df_ests |>
  rbind(psi_hat_pnt |>
          as.data.frame() |>
          mutate(method = "GAM"))

ggplot(df_ests, aes(x = a, y = y_hat, color = method, fill = method)) +
  geom_line() +
  geom_point() + 
  ylim(c(0,100)) +
  geom_ribbon(aes(ymin=ci_lwr, ymax=ci_upr),alpha=0.3) +
  theme_bw() +
  labs(title = "Estimated DRCs with available 95% CIs")
```

